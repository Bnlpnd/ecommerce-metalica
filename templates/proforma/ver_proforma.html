<div class="card mb-3">
  <div class="card-body">
    <h5>Cliente: {{ proforma.cliente.get_full_name }}</h5>
    <p>Fecha: {{ proforma.fecha|date:"d \d\e F \d\e Y" }} | Estado: {{ proforma.estado }}</p>
  </div>
</div>

{% for c in cotizaciones %}
  <div class="card mb-3">
    <div class="card-header">
      {{ c.producto.product.product_name }} 
      <button type="button" class="btn btn-sm btn-outline-primary float-end" onclick="toggleOpciones('{{ c.id }}')">Cotizar</button>
    </div>

    <div class="card-body">
      <!-- FORMULARIO OCULTO POR CADA COTIZACIÓN -->
      <div id="formulario-{{ c.id }}" class="mt-3" style="display: none;">
        <form method="POST" action="{% url 'guardar_opciones_cotizacion' %}" >
          {% csrf_token %}
          <input type="hidden" name="cotizacion_id" value="{{ c.id }}">
          <!-- Campos ocultos que usarás para predecir el precio -->
          <input type="hidden" id="alto_{{ c.id }}" value="{{ c.alto }}">
          <input type="hidden" id="ancho_{{ c.id }}" value="{{ c.ancho }}">
          <input type="hidden" id="producto_{{ c.id }}" value="{{ c.producto.id }}">
          <input type="hidden" id="cantidad_{{ c.id }}" value="{{ c.cantidad }}">

          <div class="row">
            {% for i in "123" %}
            <div class="col-md-4">
              <div class="border rounded p-2 mb-2">
                <strong>Opción {{ forloop.counter }}</strong>
                <input type="text" class="form-control form-control-sm mb-1" name="titulo[]" placeholder="Ej. Básico">
                <label class="form-label small mt-2">Tipo de material</label>


                <select name="material_id[]" class="form-select form-select-sm mb-1"  id="material_{{ c.id }}_{{ forloop.counter0 }}">
                    <option value="">Seleccione</option>
                    {% for m in materiales %}
                        <option value="{{ m.material_name }}">{{ m.material_name }}</option>
                    {% endfor %}
                </select>
                
                <input type="text" class="form-control form-control-sm mb-1" name="chapa[]" placeholder="Ej. Chapa a la izquierda abre a la derecha">

                <input type="text" class="form-control form-control-sm mb-1" name="detalle_material[]" placeholder="Detalle del material">
                <textarea class="form-control form-control-sm" name="descripcion_adicional[]" rows="2" placeholder="Comentario adicional (opcional)"></textarea>

                <input type="number" step="0.01" class="form-control form-control-sm mb-1" name="precioinstalacion[]" id="instalacion_{{ c.id }}_{{ forloop.counter0 }}" placeholder="Precio de instalación" oninput="calcularTotal('{{ c.id }}', '{{ forloop.counter0 }}')" >

                <div class="input-group input-group-sm mb-1">

                    <input type="text" class="form-control" name="precio_predicho[]" placeholder="S/. 0.00" id="precio_predicho_{{ c.id }}_{{ forloop.counter0 }}" readonly>

                    <button type="button" class="btn btn-outline-secondary" onclick="predecirPrecio('{{ c.id }}', '{{ forloop.counter0 }}', '{{ c.alto }}', '{{ c.ancho }}', '{{ c.producto.product.product_name }}')">Predecir precio</button>
                </div>
                
                <input type="number" step="0.01" name="precio_real[]" id="real_{{ c.id }}_{{ forloop.counter0 }}" class="form-control form-control-sm mb-1" placeholder="Precio real" oninput="calcularTotal('{{ c.id }}', '{{ forloop.counter0 }}')" >
                
                <input type="number" step="0.01" class="form-control form-control-sm mb-1" name="preciototal[]" id="total_{{ c.id }}_{{ forloop.counter0 }}" placeholder="Precio total" readonly>
              </div>

            </div>
            {% endfor %}
          </div>
        </form>
      </div>

      <!-- DETALLES DE LA COTIZACIÓN -->
      <p><strong>Cantidad:</strong> {{ c.cantidad }}</p>
      <p><strong>Alto:</strong> {{ c.alto }} cm | <strong>Ancho:</strong> {{ c.ancho }} cm</p>
      <p><strong>Color y acabado:</strong> {{ c.color }}
      <p><strong>Preguntas:</strong><br>
        1. {{ c.pregunta_1 }}<br>
        2. {{ c.pregunta_2 }}<br>
        3. {{ c.pregunta_3 }}
      </p>
    </div>
  </div>

{% endfor %}


<div class="text-end mt-3">
  <button onclick="document.getElementById('form-cotizaciones').submit();" class="btn btn-success">
    Guardar PDF General
  </button>
</div>

