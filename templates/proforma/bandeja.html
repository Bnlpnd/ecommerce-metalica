{% extends 'accounts/dashboard_trabajador_base.html' %}

{% block tab %}

  <div class="row">
    <!-- Bandeja lateral -->
    <div class="col-md-3">
        <h5>Proformas pendientes</h5>
        <div class="list-group">
            {% for p in proformas %}
            <a href="#" onclick="mostrarProforma('{{ p.proforma_num }}')" 
                class="list-group-item list-group-item-action {% if p.uid == proforma_mas_antigua.uid %}border-success bg-light-success{% endif %}">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <strong>{{ p.proforma_num }}</strong>
                        {% if p.uid == proforma_mas_antigua.uid %}
                            <span class="badge bg-success ms-2">Siguiente</span>
                        {% endif %}
                        <br>
                        <small>{{ p.cliente.username }}</small><br>
                        <small>{{ p.fecha|date:"d/m/Y" }}</small>
                    </div>
                </div>
            </a>

            {% empty %}
            <p class="text-muted px-3">No hay proformas pendientes.</p>
            {% endfor %}
        </div>
    </div>

    <!-- Panel derecho: Detalle de proforma -->
    <div class="col-md-9" id="detalle-proforma">
      <p class="text-muted">Selecciona una proforma para revisar detalles.</p>
    </div>
  </div>

<script>

  function mostrarProforma(proforma_num) {
    const nuevaURL = `/proforma/bandeja/${proforma_num}/`;
    window.history.pushState({ proforma: proforma_num }, '', nuevaURL);

    fetch(`/proforma/ver/without_layout/${proforma_num}`)
      .then(response => {
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
          return response.json();
        } else {
          return response.text();
        }
      })
      .then(data => {
        if (typeof data === 'object' && data.error) {
          // Mostrar di√°logo de advertencia
          mostrarDialogoAdvertencia(data.message, data.proforma_mas_antigua);
        } else {
          // Mostrar el detalle de la proforma
          document.getElementById("detalle-proforma").innerHTML = data;
        }
      })
      .catch(error => {
        console.error('Error al cargar proforma:', error);
        document.getElementById("detalle-proforma").innerHTML = '<p class="text-danger">Error al cargar la proforma.</p>';
      });
  }

  function mostrarDialogoAdvertencia(mensaje, proformaMasAntigua) {
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'modalAdvertencia';
    modal.setAttribute('tabindex', '-1');
    modal.setAttribute('aria-labelledby', 'modalAdvertenciaLabel');
    modal.setAttribute('aria-hidden', 'true');
    
    modal.innerHTML = `
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-warning">
            <h5 class="modal-title" id="modalAdvertenciaLabel">
              <i class="fas fa-exclamation-triangle"></i> Atenci√≥n Requerida
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="alert alert-warning" role="alert">
              <h6 class="alert-heading">Orden de Atenci√≥n</h6>
              <p>${mensaje}</p>
              <hr>
              <p class="mb-0">
                <strong>Proforma m√°s antigua pendiente:</strong> ${proformaMasAntigua}
              </p>
            </div>
            <p>Por favor, atienda primero la proforma m√°s antigua antes de continuar con las m√°s recientes.</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" onclick="abrirProformaMasAntigua('${proformaMasAntigua}')">
              <i class="fas fa-arrow-right"></i> Ir a Proforma ${proformaMasAntigua}
            </button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
          </div>
        </div>
      </div>
    `;
    
    // Agregar el modal al body
    document.body.appendChild(modal);
    
    // Mostrar el modal
    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();
    
    // Limpiar el modal cuando se cierre
    modal.addEventListener('hidden.bs.modal', function() {
      document.body.removeChild(modal);
    });
  }

  function abrirProformaMasAntigua(proformaNum) {
    // Cerrar el modal actual
    const modal = document.getElementById('modalAdvertencia');
    if (modal) {
      const bootstrapModal = bootstrap.Modal.getInstance(modal);
      bootstrapModal.hide();
    }
    
    // Abrir la proforma m√°s antigua
    mostrarProforma(proformaNum);
  }

  function toggleOpciones(id) {
    const form = document.getElementById("formulario-" + id);
    if (form) {
      form.style.display = form.style.display === "none" ? "block" : "none";
      console.log("‚úîÔ∏è Mostrando formulario de:", id);
    } else {
      console.log("‚ùå No se encontr√≥ el formulario:", id);
    }
  }

  function predecirPrecio(cotizacionId, index, alto, ancho, productoNombre) {
    const materialSelectId = `material_${cotizacionId}_${index}`;
    const materialSelect = document.getElementById(materialSelectId);
    const materialNombre = materialSelect?.value;

    const precioInputId = `precio_predicho_${cotizacionId}_${index}`;
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    console.log("üîç materialSelect ID:", materialSelectId);
    console.log("üì¶ materialNombre:", materialNombre);
    console.log("üì¶ productoNombre:", productoNombre);
    console.log("üì¶ alto:", alto);
    console.log("üì¶ ancho:", ancho);

    if (!materialNombre) {
      alert("Selecciona un material para predecir el precio.");
      return;
    }

    fetch("{% url 'predecir_precio' %}", {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': csrfToken
      },
      body: new URLSearchParams({
        alto: alto,
        ancho: ancho,
        producto_nombre: productoNombre,
        material_nombre: materialNombre
      })
    })
    .then(res => res.json())
    .then(data => {
      console.log("‚úÖ Respuesta:", data);
      const input = document.getElementById(precioInputId);
      if (input) input.value = `S/. ${data.precio}`;
    })
    .catch(err => {
      console.error("‚ùå Error al predecir:", err);
    });
  }

  function calcularTotal(cotizacionId, index) {
    const inst = document.getElementById(`instalacion_${cotizacionId}_${index}`);
    const real = document.getElementById(`real_${cotizacionId}_${index}`);
    const total = document.getElementById(`total_${cotizacionId}_${index}`);
    const cantidadElem = document.getElementById(`cantidad_${cotizacionId}`);

    const precioInstalacion = parseFloat(inst.value) || 0;
    const precioReal = parseFloat(real.value) || 0;
    const cantidad = parseFloat(cantidadElem.value) || 1;

    const suma = (precioInstalacion + precioReal) * cantidad;
    total.value = suma.toFixed(2);
  }

</script>



{% endblock %}
