{% extends 'home/base.html' %} {% load static %} {% block content %}
<div class="container mt-4">
  <h2 class="mb-4">
    Proforma 
    <span id="contador-productos" class="badge bg-primary ms-2" style="display: none;">0 productos</span>
  </h2>
  {% if error_message %}
  <div class="alert alert-warning" id="custom-error">
    {{ error_message }}
  </div>
  {% endif %}
  <div class="alert alert-warning" id="custom-error-js" style="display: none;"></div>


  {% if request.user.profile %}
  <div class="alert alert-warning d-flex justify-content-between align-items-center flex-wrap">
    <div>
      <strong>Informaci√≥n del cliente:</strong><br>
      <ul class="mb-0">
        <li><strong>Nombre:</strong> {{ request.user.get_full_name }}</li>
        <li><strong>DNI:</strong> {{ request.user.profile.dni|default:"No registrado" }}</li>
        <li><strong>Tel√©fono:</strong> {{ request.user.profile.phone_number|default:"No registrado" }}</li>
        <li><strong>Direcci√≥n:</strong> {{ request.user.profile.direccion|default:"No registrado" }}</li>
        <li><strong>Referencia:</strong> {{ request.user.profile.referencia|default:"No registrado" }}</li>
        <li><strong>Distrito:</strong> {{ request.user.profile.distrito|default:"No registrado" }}</li>
      </ul>
    </div>
    <div class="text-end mt-2 mt-md-0">
      {% if not request.user.profile.dni or not request.user.profile.direccion or not request.user.profile.phone_number or not request.user.profile.referencia or not  request.user.profile.distrito  %}
        <a href="{% url 'perfil_cliente' %}" class="btn btn-danger btn-sm mb-1">Completar perfil</a>
      {% else %}
        <span class="badge bg-success p-2 mb-1">Perfil completo</span><br>
        <a href="{% url 'perfil_cliente' %}" class="btn btn-outline-primary btn-sm mt-1">Editar perfil</a>
      {% endif %}
    </div>
  </div>
  {% endif %}


  <!-- FORMULARIO -->
  <form method="POST" action="{% url 'guardar_proforma' %}">
    {% csrf_token %}

    <button type="button" onclick="a√±adirFila()" class="btn btn-outline-secondary btn-sm mb-3 d-flex align-items-center gap-1" style="margin-left: auto;">
        <i class="fas fa-plus"></i> A√±adir producto
    </button>
    <div class="table-responsive rounded-3 border mb-2">
      <table id="tabla-proforma" class="table align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>Cant</th>
            <th>Producto</th>
            <th>Modelo de puerta</th>
            <th>Imagen</th>
            <th>
              Medidas(cm)
              <button
                class="btn btn-sm btn-outline-secondary py-0 px-1"
                onclick="mostrarAyuda()"
                type="button"
              >
                ?
              </button>
            </th>
            <th>Color y acabado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="cuerpo-proforma">
          <tr>
            <td>
              <input type="number" name="cantidad[]" value="1" min="1" max="20" class="form-control form-control-sm" required oninvalid="this.setCustomValidity('Debe ingresar una cantidad v√°lida entre 1 y 20')"
              oninput="this.setCustomValidity('')"/>
            </td>
            <td>
              <select name="producto[]" class="form-select form-select-sm productos" onchange="cargarModelos(this)" required oninvalid="this.setCustomValidity('Debe selecionar un producto')"
              oninput="this.setCustomValidity('')">
                <option value="">Seleccione</option>
                {% for producto in productos %}
                  <option value="{{ producto.uid }}">{{ producto.product_name }}</option>
                {% endfor %}
              </select>
            </td>
            <td>
              <select name="modelo[]" class="form-select form-select-sm modelo-puerta" onchange="actualizarImagen(this)">
                <option value="">--</option>
              </select>
            </td>
            <td>
              <img src="" class="imagen-modelo" width="70" style="display: none; border-radius: 5px" />
            </td>
            <td>
              <input type="number" name="alto[]" placeholder="Alto" class="form-control form-control-sm mb-1" maxlength="3" min="190" max="550" step="1" required oninvalid="this.setCustomValidity('El valor debe estar entre 190 y 550 cm.')"
              oninput="this.setCustomValidity('')"/> 

              <input type="number" name="ancho[]" placeholder="Ancho" class="form-control form-control-sm mb-1" maxlength="3" min="85" max="350" step="1" required oninvalid="this.setCustomValidity('El valor debe estar entre 85 y 350 cm.')"
              oninput="this.setCustomValidity('')"/> 
            </td>
            <td>
              <input type="text" name="color[]" class="form-control form-control-sm" placeholder="Ej. Negro mate" maxlength="30" required oninvalid="this.setCustomValidity('Debe ingresar un color')"
              oninput="this.setCustomValidity('')"/>
            </td>
            <td class="text-center">
              <button class="btn btn-primary btn-sm" type="button" onclick="abrirModal(this)">Detalle</button>
              <button class="btn btn-danger btn-sm" type="button" onclick="eliminarFila(this)"><i class="fas fa-trash"></i></button>

              <!-- CAMPOS OCULTOS para preguntas -->
              <input type="hidden" name="pregunta1[]" value="" required oninvalid="this.setCustomValidity('Debe ingresar datos')"
              oninput="this.setCustomValidity('')"/>
              <input type="hidden" name="pregunta2[]" value="" required oninvalid="this.setCustomValidity('Debe ingresar datos')"
              oninput="this.setCustomValidity('')"/>
              <input type="hidden" name="pregunta3[]" value="" required oninvalid="this.setCustomValidity('Debe ingresar datos')"
              oninput="this.setCustomValidity('')"/>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <br />
    <button type="submit" class="btn btn-success d-flex align-items-center gap-1" style="margin-left: auto;">
      <i class="fas fa-check"></i>Enviar proforma</button>
  </form>
</div>

<!-- MODAL DETALLE -->
<div id="modalDetalle" style="display: none; position: fixed; top: 20%; left: 50%; transform: translateX(-50%); background: white; padding: 20px; border-radius: 10px; border: 1px solid #ccc; z-index: 999;">
  <h5 class="mb-3">Preguntas adicionales</h5>
  <div class="mb-2">
    <label>Deme una breve descripci√≥n de d√≥nde ser√° instalado el modelo que ha seleccionado.</label>
    <input type="text" class="form-control form-control-sm" id="p1" />
  </div>
  <div class="mb-2">
    <label>Si su modelo incluye chapa, imagine que se encuentra frente a su puerta y describa en sus palabras para qu√© lado abre la puerta.</label>
    <input type="text" class="form-control form-control-sm" id="p2" />
  </div>
  <div class="mb-3">
    <label>¬øDesea agregar el servicio de instalado? De ser as√≠, verificar que la direcci√≥n de la instalaci√≥n sea la que ha registrado o de ser otra direcci√≥n, escribirla en el recuadro junto a una referencia.</label>
    <input type="text" class="form-control form-control-sm" id="p3" />
  </div>
  <div class="text-end">
    <button onclick="cerrarModal()" class="btn btn-secondary btn-sm">Cerrar</button>
  </div>
</div>

<!-- SCRIPTS -->
<script>
  let filaActiva = null;
  const STORAGE_KEY = 'proforma_draft';

  // Funciones para manejar localStorage
  function guardarEnLocalStorage() {
    const filas = document.querySelectorAll('#cuerpo-proforma tr');
    const datos = [];
    
    filas.forEach((fila, index) => {
      const cantidad = fila.querySelector('input[name="cantidad[]"]').value;
      const producto = fila.querySelector('select[name="producto[]"]').value;
      const modelo = fila.querySelector('select[name="modelo[]"]').value;
      const alto = fila.querySelector('input[name="alto[]"]').value;
      const ancho = fila.querySelector('input[name="ancho[]"]').value;
      const color = fila.querySelector('input[name="color[]"]').value;
      const pregunta1 = fila.querySelector('input[name="pregunta1[]"]').value;
      const pregunta2 = fila.querySelector('input[name="pregunta2[]"]').value;
      const pregunta3 = fila.querySelector('input[name="pregunta3[]"]').value;
      
      // Solo guardar si hay al menos un campo con datos
      if (cantidad || producto || modelo || alto || ancho || color || pregunta1 || pregunta2 || pregunta3) {
        datos.push({
          cantidad: cantidad || '',
          producto: producto || '',
          modelo: modelo || '',
          alto: alto || '',
          ancho: ancho || '',
          color: color || '',
          pregunta1: pregunta1 || '',
          pregunta2: pregunta2 || '',
          pregunta3: pregunta3 || ''
        });
      }
    });
    
    localStorage.setItem(STORAGE_KEY, JSON.stringify(datos));
    console.log('üíæ Proforma guardada en localStorage:', datos);
    actualizarContadorProductos();
  }

  function cargarDesdeLocalStorage() {
    const datos = localStorage.getItem(STORAGE_KEY);
    if (datos) {
      try {
        const filasDatos = JSON.parse(datos);
        console.log('üìÇ Cargando proforma desde localStorage:', filasDatos);
        
        // Limpiar filas existentes excepto la primera
        const tabla = document.getElementById('cuerpo-proforma');
        while (tabla.rows.length > 1) {
          tabla.deleteRow(1);
        }
        
        // Cargar cada fila de datos
        filasDatos.forEach((filaDatos, index) => {
          if (index === 0) {
            // Usar la primera fila existente
            llenarFila(tabla.rows[0], filaDatos);
          } else {
            // Crear nuevas filas sin guardar en localStorage (para evitar recursi√≥n)
            a√±adirFilaSinGuardar();
            llenarFila(tabla.rows[tabla.rows.length - 1], filaDatos);
          }
        });
      } catch (error) {
        console.error('‚ùå Error cargando desde localStorage:', error);
      }
    }
  }

  function llenarFila(fila, datos) {
    console.log('üîß Llenando fila con datos:', datos);
    
    fila.querySelector('input[name="cantidad[]"]').value = datos.cantidad || '';
    fila.querySelector('input[name="alto[]"]').value = datos.alto || '';
    fila.querySelector('input[name="ancho[]"]').value = datos.ancho || '';
    fila.querySelector('input[name="color[]"]').value = datos.color || '';
    fila.querySelector('input[name="pregunta1[]"]').value = datos.pregunta1 || '';
    fila.querySelector('input[name="pregunta2[]"]').value = datos.pregunta2 || '';
    fila.querySelector('input[name="pregunta3[]"]').value = datos.pregunta3 || '';
    
    // Manejar producto y modelo
    const productoSelect = fila.querySelector('select[name="producto[]"]');
    const modeloSelect = fila.querySelector('select[name="modelo[]"]');
    
    if (datos.producto) {
      productoSelect.value = datos.producto;
      console.log('üì¶ Producto seleccionado:', datos.producto);
      
      // Cargar modelos para este producto
      cargarModelos(productoSelect);
      
      // Esperar a que se carguen los modelos y seleccionar el modelo
      setTimeout(() => {
        if (datos.modelo) {
          modeloSelect.value = datos.modelo;
          console.log('üè∑Ô∏è Modelo seleccionado:', datos.modelo);
          actualizarImagen(modeloSelect);
        }
      }, 800); // Aumentar tiempo de espera
    }
  }

  function limpiarLocalStorage() {
    localStorage.removeItem(STORAGE_KEY);
    console.log('üóëÔ∏è localStorage limpiado');
    actualizarContadorProductos();
  }

  function actualizarContadorProductos() {
    const contador = document.getElementById('contador-productos');
    const datos = localStorage.getItem(STORAGE_KEY);
    
    if (datos) {
      try {
        const productos = JSON.parse(datos);
        if (productos.length > 0) {
          contador.textContent = `${productos.length} producto${productos.length > 1 ? 's' : ''}`;
          contador.style.display = 'inline-block';
        } else {
          contador.style.display = 'none';
        }
      } catch (error) {
        contador.style.display = 'none';
      }
    } else {
      contador.style.display = 'none';
    }
  }

  // Autocompletar campos si se pasaron par√°metros desde detalle del producto
  document.addEventListener('DOMContentLoaded', function() {
    // Variables del servidor
    const productoUid = '{{ producto_seleccionado.uid|default:"" }}';
    const modeloUid = '{{ modelo_seleccionado.uid|default:"" }}';
    const productoNombre = '{{ producto_seleccionado.product_name|default:"" }}';
    const modeloNombre = '{{ modelo_seleccionado.productmaterial_name|default:"" }}';
    
    console.log('üîç Datos recibidos del servidor:');
    console.log('  - Producto UID:', productoUid);
    console.log('  - Modelo UID:', modeloUid);
    console.log('  - Producto Nombre:', productoNombre);
    console.log('  - Modelo Nombre:', modeloNombre);
    
    // Solo proceder si tenemos ambos par√°metros
    if (productoUid && modeloUid) {
      console.log('‚úÖ Iniciando autocompletado...');
      
      // Obtener la primera fila
      const primeraFila = document.querySelector('#cuerpo-proforma tr');
      if (primeraFila) {
        const productoSelect = primeraFila.querySelector('select[name="producto[]"]');
        const modeloSelect = primeraFila.querySelector('select[name="modelo[]"]');
        
        if (productoSelect && modeloSelect) {
          // Seleccionar el producto
          productoSelect.value = productoUid;
          console.log('üì¶ Producto seleccionado en select:', productoSelect.value);
          
          // Cargar los modelos para ese producto
          cargarModelos(productoSelect);
          
          // Esperar un poco para que se carguen los modelos y luego seleccionar el modelo
          setTimeout(() => {
            modeloSelect.value = modeloUid;
            console.log('üè∑Ô∏è Modelo seleccionado en select:', modeloSelect.value);
            actualizarImagen(modeloSelect);
            // Guardar despu√©s del autocompletado
            guardarEnLocalStorage();
          }, 500);
        } else {
          console.log('‚ùå No se encontraron los selects necesarios');
        }
      } else {
        console.log('‚ùå No se encontr√≥ la primera fila');
      }
    } else {
      console.log('‚ÑπÔ∏è No hay par√°metros suficientes para autocompletar');
      // Cargar desde localStorage si no hay par√°metros
      cargarDesdeLocalStorage();
    }
    
    // Configurar event listeners para guardar autom√°ticamente
    configurarEventListeners();
    
    // Actualizar contador de productos al cargar la p√°gina
    actualizarContadorProductos();
  });

  function configurarEventListeners() {
    // Guardar en localStorage cuando cambien los campos
    document.addEventListener('input', function(e) {
      if (e.target.matches('input[name="cantidad[]"], input[name="alto[]"], input[name="ancho[]"], input[name="color[]"], input[name="pregunta1[]"], input[name="pregunta2[]"], input[name="pregunta3[]"]')) {
        guardarEnLocalStorage();
      }
    });
    
    document.addEventListener('change', function(e) {
      if (e.target.matches('select[name="producto[]"], select[name="modelo[]"]')) {
        guardarEnLocalStorage();
      }
    });
  }

  function mostrarAyuda() {
    alert("üìè Usa una cinta m√©trica para medir el alto y ancho del vano donde se instalar√° la puerta. Mide en cent√≠metros. Si tienes alg√∫n problema con las medidas cont√°ctanos al n√∫mero: 979525640");
  }

  function cargarModelos(select) {
    let productoId = select.value;
    if (!productoId) return;

    let row = select.closest("tr");
    let modeloSelect = row.querySelector(".modelo-puerta");
    let imagen = row.querySelector(".imagen-modelo");

    modeloSelect.innerHTML = "<option value=''>Cargando...</option>";
    imagen.style.display = "none";
    imagen.src = "";

    fetch(`/product/ajax/modelos_por_tipo/?product_id=${productoId}`)
      .then((response) => response.json())
      .then((data) => {
        modeloSelect.innerHTML = "";
        if (data.modelos.length === 0) {
          modeloSelect.innerHTML = "<option value=''>Sin modelos disponibles</option>";
          return;
        }

        data.modelos.forEach((modelo, index) => {
          let opt = document.createElement("option");
          opt.value = modelo.id;
          opt.textContent = modelo.nombre;
          opt.dataset.imagen = modelo.imagen_url;
          modeloSelect.appendChild(opt);

          if (index === 0 && modelo.imagen_url) {
            imagen.src = modelo.imagen_url;
            imagen.style.display = "block";
          }
        });
      });
  }

  function actualizarImagen(select) {
    let row = select.closest("tr");
    let imagen = row.querySelector(".imagen-modelo");
    let selected = select.selectedOptions[0];

    if (selected.dataset.imagen) {
      imagen.src = selected.dataset.imagen;
      imagen.style.display = "block";
    } else {
      imagen.style.display = "none";
    }
  }

  function abrirModal(btn) {
    filaActiva = btn.closest("tr");

    // Rellenar si ya ten√≠a valores
    document.getElementById("p1").value = filaActiva.querySelector("input[name='pregunta1[]']").value;
    document.getElementById("p2").value = filaActiva.querySelector("input[name='pregunta2[]']").value;
    document.getElementById("p3").value = filaActiva.querySelector("input[name='pregunta3[]']").value;
    document.getElementById("modalDetalle").style.display = "block";
    
    // Agregar event listeners para guardar autom√°ticamente mientras se escribe
    const p1 = document.getElementById("p1");
    const p2 = document.getElementById("p2");
    const p3 = document.getElementById("p3");
    
    const guardarPreguntas = () => {
      if (filaActiva) {
        filaActiva.querySelector("input[name='pregunta1[]']").value = p1.value;
        filaActiva.querySelector("input[name='pregunta2[]']").value = p2.value;
        filaActiva.querySelector("input[name='pregunta3[]']").value = p3.value;
        guardarEnLocalStorage();
      }
    };
    
    // Remover listeners anteriores si existen
    p1.removeEventListener('input', guardarPreguntas);
    p2.removeEventListener('input', guardarPreguntas);
    p3.removeEventListener('input', guardarPreguntas);
    
    // Agregar nuevos listeners
    p1.addEventListener('input', guardarPreguntas);
    p2.addEventListener('input', guardarPreguntas);
    p3.addEventListener('input', guardarPreguntas);
  }

  function cerrarModal() {
    if (filaActiva) {
      filaActiva.querySelector("input[name='pregunta1[]']").value = document.getElementById("p1").value;
      filaActiva.querySelector("input[name='pregunta2[]']").value = document.getElementById("p2").value;
      filaActiva.querySelector("input[name='pregunta3[]']").value = document.getElementById("p3").value;
      
      // Guardar en localStorage despu√©s de actualizar las preguntas
      guardarEnLocalStorage();
    }
    document.getElementById("modalDetalle").style.display = "none";
  }

  function a√±adirFila() {
    a√±adirFilaSinGuardar();
    // Guardar en localStorage despu√©s de agregar fila
    guardarEnLocalStorage();
  }

  function a√±adirFilaSinGuardar() {
    let tabla = document.getElementById("cuerpo-proforma");
    let fila = tabla.rows[0].cloneNode(true);
    
    // Resetear todos los inputs excepto cantidad
    fila.querySelectorAll("input").forEach((el) => {
      if (el.type === "checkbox") {
        el.checked = false;
      } else if (el.name === "cantidad[]") {
        // Mantener cantidad en 1 para nuevas filas
        el.value = "1";
      } else {
        // Limpiar todos los dem√°s campos
        el.value = "";
      }
    });

    // Resetear selects
    fila.querySelectorAll("select").forEach((el) => {
      if (el.name === "producto[]") {
        // Para el select de producto, solo resetear √≠ndice
        el.selectedIndex = 0;
      } else if (el.name === "modelo[]") {
        // Para el select de modelo, limpiar completamente las opciones
        el.innerHTML = "<option value=''>--</option>";
      }
    });

    // Limpiar imagen
    fila.querySelector(".imagen-modelo").style.display = "none";
    fila.querySelector(".imagen-modelo").src = "";
    
    // Limpiar campos ocultos de preguntas
    fila.querySelectorAll("input[name='pregunta1[]'], input[name='pregunta2[]'], input[name='pregunta3[]']").forEach((el) => {
      el.value = "";
    });
    
    tabla.appendChild(fila);
  }

  function eliminarFila(btn) {
    let row = btn.closest("tr");
    let tabla = document.getElementById("cuerpo-proforma");
    if (tabla.rows.length > 1) {
      row.remove();
      // Guardar en localStorage despu√©s de eliminar fila
      guardarEnLocalStorage();
    } else {
      alert("Debe haber al menos una fila.");
    }
  }

  document.querySelector("form").addEventListener("submit", function (e) {
    const filas = document.querySelectorAll("#cuerpo-proforma tr");
    let valido = true;
    let mensajeError = "";

    filas.forEach((fila, index) => {
      const cantidad = fila.querySelector("input[name='cantidad[]']").value;
      const producto = fila.querySelector("select[name='producto[]']").value;
      const modelo = fila.querySelector("select[name='modelo[]']").value;
      const alto = fila.querySelector("input[name='alto[]']").value;
      const ancho = fila.querySelector("input[name='ancho[]']").value;
      const color = fila.querySelector("input[name='color[]']").value;
      const p1 = fila.querySelector("input[name='pregunta1[]']").value;
      const p2 = fila.querySelector("input[name='pregunta2[]']").value;
      const p3 = fila.querySelector("input[name='pregunta3[]']").value;

      if (!cantidad || !producto || !modelo || !alto || !ancho || !color || !p1 || !p2 || !p3) {
        valido = false;
        mensajeError = `‚ö†Ô∏è Debes completar todos los campos en la fila ${index + 1}. Incluye tambi√©n las preguntas del detalle.`;

      }
    });

    if (!valido) {
      e.preventDefault(); // Detener el env√≠o
      const errorDiv = document.getElementById("custom-error-js");
      errorDiv.textContent = mensajeError;
      errorDiv.style.display = "block";
    } else {
      // Si el formulario es v√°lido, limpiar localStorage antes de enviar
      limpiarLocalStorage();
    }

  });

</script>
{% endblock %}
