{% extends 'home/base.html' %} {% load static %} {% block content %}
<div class="container mt-4">
  <h2 class="mb-4">PROFORMA</h2>

  <div class="table-responsive">
    <table id="tabla-proforma" class="table table-bordered align-middle">
      <thead class="table-light">
        <tr>
          <th>Cant</th>
          <th>Producto</th>
          <th>Modelo de puerta</th>
          <th>Imagen</th>
          <th>
            Medidas
            <button
              class="btn btn-sm btn-outline-secondary py-0 px-1"
              onclick="mostrarAyuda()"
            >
              ?
            </button>
          </th>
          <th>Color</th>
          <th>Instalaci√≥n</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="cuerpo-proforma">
        <tr>
          <td>
            <input
              type="number"
              name="cantidad"
              value="1"
              min="1"
              class="form-control form-control-sm"
            />
          </td>
          <td>
            <select
              class="form-select form-select-sm productos"
              onchange="cargarModelos(this)"
            >
              <option value="">Seleccione</option>
              {% for producto in productos %}
              <option value="{{ producto.uid }}">{{ producto.product_name }}</option>
              {% endfor %}
            </select>
          </td>
          <td>
            <select
              class="form-select form-select-sm modelo-puerta"
              onchange="actualizarImagen(this)"
            >
              <option value="">--</option>
            </select>
          </td>
          <td>
            <img
              src=""
              class="imagen-modelo"
              width="70"
              style="display: none; border-radius: 5px"
            />
          </td>
          <td>
            <input
              type="text"
              name="alto"
              placeholder="Alto"
              class="form-control form-control-sm mb-1"
            />
            <input
              type="text"
              name="ancho"
              placeholder="Ancho"
              class="form-control form-control-sm"
            />
          </td>
          <td>
            <input
              type="text"
              name="color"
              class="form-control form-control-sm"
              placeholder="Ej. Negro mate"
            />
          </td>
          <td class="text-center">
            <input type="checkbox" name="instalacion" />
          </td>
          <td class="text-center">
            <button
              class="btn btn-outline-secondary btn-sm"
              onclick="abrirModal(this)"
            >
              Detalle
            </button>
            <button class="btn btn-warning btn-sm mx-1">‚úèÔ∏è</button>
            <button class="btn btn-danger btn-sm" onclick="eliminarFila(this)">
              ‚úñ
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <button onclick="a√±adirFila()" class="btn btn-outline-dark btn-sm mb-3">
    A√±adir producto
  </button>
  <br />
  <button class="btn btn-warning">Enviar proforma</button>
</div>

<!-- Modal de detalle -->
<div
  id="modalDetalle"
  style="
    display: none;
    position: fixed;
    top: 20%;
    left: 50%;
    transform: translateX(-50%);
    background: white;
    padding: 20px;
    border-radius: 10px;
    border: 1px solid #ccc;
    z-index: 999;
  "
>
  <h5 class="mb-3">Preguntas adicionales</h5>
  <div class="mb-2">
    <label>¬øD√≥nde se instalar√° la puerta?</label>
    <input type="text" class="form-control form-control-sm" />
  </div>
  <div class="mb-2">
    <label>¬øRequiere pintura especial?</label>
    <input type="text" class="form-control form-control-sm" />
  </div>
  <div class="mb-3">
    <label>¬øTiene alguna medida especial?</label>
    <input type="text" class="form-control form-control-sm" />
  </div>
  <div class="text-end">
    <button onclick="cerrarModal()" class="btn btn-secondary btn-sm">
      Cerrar
    </button>
  </div>
</div>

<script>
  function mostrarAyuda() {
    alert(
      "üìè Usa una cinta m√©trica para medir el alto y ancho del vano donde se instalar√° la puerta. Mide en cent√≠metros. Aseg√∫rate que el vano est√© nivelado."
    );
  }

  function cargarModelos(select) {
    let productoId = select.value;

    if (!productoId) {
      console.warn("No se seleccion√≥ producto.");
      return; // Detiene ejecuci√≥n si no hay ID v√°lido
    }

    let row = select.closest("tr");
    let modeloSelect = row.querySelector(".modelo-puerta");
    let imagen = row.querySelector(".imagen-modelo");

    // Reiniciar imagen y opciones
    modeloSelect.innerHTML = "<option value=''>Cargando...</option>";
    imagen.style.display = "none";
    imagen.src = "";

    fetch(`/product/ajax/modelos_por_tipo/?product_id=${productoId}`)
      .then((response) => response.json())
      .then((data) => {
        console.log(data); // üëà verifica esto en la consola del navegador
        modeloSelect.innerHTML = ""; // Limpiar el select

        if (data.modelos.length === 0) {
          modeloSelect.innerHTML =
            "<option value=''>Sin modelos disponibles</option>";
          return;
        }

        // Insertar opciones
        data.modelos.forEach((modelo, index) => {
          let opt = document.createElement("option");
          opt.value = modelo.id;
          opt.textContent = modelo.nombre;
          opt.dataset.imagen = modelo.imagen_url;
          modeloSelect.appendChild(opt);

          // Mostrar imagen del primer modelo por defecto
          if (index === 0 && modelo.imagen_url) {
            imagen.src = modelo.imagen_url;
            imagen.style.display = "block";
          }
        });
      })
      .catch((error) => {
        console.error("Error en fetch modelos:", error);
      });
  }

  // Asigna el evento a todos los selects tipo-puerta
  document.querySelectorAll(".tipo-puerta").forEach((select) => {
    select.addEventListener("change", function () {
      cargarModelos(this);
    });
  });

  function actualizarImagen(select) {
    let row = select.closest("tr");
    let imagen = row.querySelector(".imagen-modelo");
    let selected = select.selectedOptions[0];

    if (selected.dataset.imagen) {
      imagen.src = selected.dataset.imagen;
      imagen.style.display = "block";
    } else {
      imagen.style.display = "none";
    }
  }

  function abrirModal(btn) {
    document.getElementById("modalDetalle").style.display = "block";
  }

  function cerrarModal() {
    document.getElementById("modalDetalle").style.display = "none";
  }

  function a√±adirFila() {
    let tabla = document.getElementById("cuerpo-proforma");
    let fila = tabla.rows[0].cloneNode(true);
    fila.querySelectorAll("input, select").forEach((input) => {
      if (input.type === "checkbox") input.checked = false;
      else input.value = "";
    });
    fila.querySelector(".imagen-modelo").style.display = "none";
    tabla.appendChild(fila);
  }

  function eliminarFila(btn) {
    let row = btn.closest("tr");
    let tabla = document.getElementById("cuerpo-proforma");
    if (tabla.rows.length > 1) {
      row.remove();
    } else {
      alert("Debe haber al menos una fila en la proforma.");
    }
  }
</script>
{% endblock %}
